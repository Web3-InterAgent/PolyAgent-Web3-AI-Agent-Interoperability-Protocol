# MCP设置和故障排除指南

## 🚀 快速开始

### 1. 自动设置
运行自动化设置脚本：
```bash
python setup_mcp_tools.py
```

这个脚本会：
- ✅ 检查系统依赖
- 📦 安装MCP服务器
- 📝 创建配置文件
- 🧪 创建测试脚本
- 🌍 设置环境配置

### 2. 手动验证
运行连接测试：
```bash
python AgentCore/Mcp/test_connection.py
```

## 🔧 问题修复

### 问题：CancelledError 和连接超时

**原因分析：**
- MCP连接被异步取消
- 网络连接不稳定
- 超时设置过短

**解决方案：**
1. **增加连接超时时间**（已实现）
   - 连接超时：30秒
   - 任务超时：60秒
   - 请求超时：65秒

2. **连接池管理**（已实现）
   - 单例模式的连接管理器
   - 连接复用和持久化
   - 自动重连机制

3. **更好的错误处理**（已实现）
   - 详细的错误分类
   - 用户友好的错误提示
   - 自动重试策略

### 问题：工具调用失败

**检查步骤：**
1. 验证MCP配置文件
2. 检查网络连接
3. 验证API密钥

**配置文件位置：**
```
AgentCore/Mcp/
├── youxuan_server.json          # 基础配置
├── enhanced_mcp_config.json     # 完整配置
├── mcp_config_active.json       # 当前使用的配置
└── test_connection.py           # 测试脚本
```

## 🧠 智能搜索功能

### 新增功能
1. **搜索质量评估**
   - 自动评分（0-100分）
   - 质量等级：优秀/良好/一般/较差
   - 多维度评估：相关性、完整度、价格合理性

2. **自动搜索优化**
   - 同义词替换
   - 关键词扩展
   - 查询简化
   - 品牌+类别组合

3. **多轮搜索**
   - 最多3轮搜索
   - 质量达标自动停止
   - 搜索历史记录

### 使用示例
```python
# 用户输入："我想买华为手机"
# 第1轮：搜索 "我想买华为手机"
# 第2轮：搜索 "华为 手机"（品牌+类别组合）
# 第3轮：搜索 "HUAWEI 智能手机 5G"（同义词+扩展）
```

## 🌐 多MCP工具集成

### 可用工具
1. **youxuan-mcp**（主要）
   - 商品搜索
   - 价格查询
   - 订单管理
   - 售后服务

2. **web-search**（补充）
   - 网络搜索
   - 商品评价
   - 价格比较

3. **fetch**（增强）
   - 网页抓取
   - 产品页面分析
   - 库存查询

4. **filesystem**（缓存）
   - 搜索历史存储
   - 用户偏好缓存

5. **sqlite**（数据）
   - 用户数据存储
   - 价格趋势分析

### 启用多工具
1. 复制配置文件：
   ```bash
   cp AgentCore/Mcp/enhanced_mcp_config.json AgentCore/Mcp/mcp_config_active.json
   ```

2. 安装额外依赖：
   ```bash
   # Node.js工具
   npm install -g @modelcontextprotocol/server-web-search
   npm install -g @modelcontextprotocol/server-filesystem
   
   # Python工具
   pip install uv
   uvx --install mcp-server-fetch
   uvx --install mcp-server-sqlite
   ```

## 📊 性能优化

### 连接管理
- ✅ 单例连接管理器
- ✅ 连接池和复用
- ✅ 自动重连机制
- ✅ 心跳检测

### 异步处理
- ✅ 改进的超时控制
- ✅ 错误分类处理
- ✅ 用户友好反馈

### 缓存机制
- 📋 搜索结果缓存（计划中）
- 📋 用户偏好缓存（计划中）
- 📋 价格历史缓存（计划中）

## 🐛 常见问题

### Q: MCP连接一直失败
**A:** 检查以下几点：
1. 网络连接是否正常
2. API密钥是否有效
3. 配置文件格式是否正确
4. 防火墙是否阻止连接

### Q: 搜索结果质量差
**A:** 系统会自动优化：
1. 使用更具体的关键词
2. 尝试不同的搜索策略
3. 最多进行3轮搜索优化

### Q: 工具调用超时
**A:** 已优化超时设置：
1. 连接超时：30秒
2. 执行超时：60秒
3. 自动重试机制

### Q: 如何添加新的MCP工具？
**A:** 修改配置文件：
1. 编辑 `enhanced_mcp_config.json`
2. 添加新的服务器配置
3. 重启应用

## 📈 监控和调试

### 日志查看
应用会输出详细的调试信息：
```
🔧 MCP连接管理器初始化完成
🔄 建立MCP连接...
✅ MCP连接成功，已加载 6 个工具
🧠 启动智能搜索模式
🔄 第 1 轮搜索
📊 搜索质量: good (75.2分)
```

### 性能指标
- 连接建立时间
- 搜索响应时间
- 质量评分
- 重试次数

## 🔮 未来计划

### 即将推出
1. **多平台价格比较**
   - 集成更多电商平台
   - 实时价格监控
   - 历史价格趋势

2. **个性化推荐**
   - 用户行为分析
   - 智能推荐算法
   - 个性化搜索排序

3. **语音交互**
   - 语音输入支持
   - 语音反馈
   - 多模态交互

### 技术改进
1. **更智能的搜索**
   - 语义理解增强
   - 上下文记忆
   - 意图识别优化

2. **更好的性能**
   - 搜索结果缓存
   - 预测性加载
   - 负载均衡

## 📞 支持

如果遇到问题，请：
1. 首先查看本指南
2. 运行测试脚本诊断
3. 查看应用日志
4. 提交Issue并附上错误信息

---

*PolyAgent团队 - 让AI购物更智能* 🛍️ 